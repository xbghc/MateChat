name: Auto Translate Docs

on:
  push:
    branches:
      - main
      - dev
      - feat/i18n-workflow
    paths:
      - 'docs/zh-CN/**/*.md'
  workflow_dispatch:
    inputs:
      files:
        description: 'Specific files to translate (comma-separated, optional)'
        required: false
        type: string
      check_all:
        description: 'Check all files for pending translations'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to find the base version
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Detect changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.files }}" ]; then
            echo "files=${{ github.event.inputs.files }}" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=""
            
            # Get recently changed files (always include these)
            RECENT_CHANGES=$(git diff --name-only HEAD~1 HEAD -- 'docs/zh-CN/**/*.md' || true)
            for file in $RECENT_CHANGES; do
              CHANGED_FILES="${CHANGED_FILES}${file},"
            done
            
            # If check_all is true or this is manual trigger with check_all
            if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.check_all }}" = "true" ]; then
              echo "Checking all files for pending translations..."
              
              # Check all zh-CN files to see if they need translation
              for zh_file in $(find docs/zh-CN -name "*.md" -type f); do
                en_file="${zh_file/zh-CN/en-US}"
                
                # Skip if already in recent changes
                if echo "$RECENT_CHANGES" | grep -q "$zh_file"; then
                  continue
                fi
                
                # Include file if English file doesn't exist
                if [ ! -f "$en_file" ]; then
                  CHANGED_FILES="${CHANGED_FILES}${zh_file},"
                  echo "  - Missing translation: $zh_file"
                fi
              done
            fi
            
            echo "files=${CHANGED_FILES%,}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run translation
        if: steps.changed-files.outputs.files != ''
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "Translating files: $CHANGED_FILES"
          node scripts/translate-docs.js
      
      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/en-US/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Reset unwanted changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Reset lock files if they were modified
          git checkout HEAD -- pnpm-lock.yaml || true
          git checkout HEAD -- package-lock.json || true
          git checkout HEAD -- yarn.lock || true
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "docs: auto-translate documentation from zh-CN to en-US"
          title: "🤖 Auto-translate docs from zh-CN to en-US"
          body: |
            ## 📚 Documentation Translation
            
            This PR contains automated translations from Chinese to English documentation.
            
            ### 📝 Changed Files
            **Source files**: 
            ```
            ${{ steps.changed-files.outputs.files }}
            ```
            
            ### ✅ Checklist
            - [ ] Translation accuracy reviewed
            - [ ] Technical terms are correct
            - [ ] Markdown formatting preserved
            - [ ] Links and references updated
            
            ### 🤖 Translation Details
            - **Service**: DeepSeek API
            - **Model**: deepseek-chat
            - **Timestamp**: ${{ github.event.head_commit.timestamp }}
            
            ---
            *This PR was automatically generated by the translation workflow.*
          branch: auto-translate/${{ github.run_number }}
          delete-branch: true