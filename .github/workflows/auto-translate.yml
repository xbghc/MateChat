name: Auto Translate Docs

on:
  push:
    branches:
      - main
      - dev
      - feat/i18n-workflow
    paths:
      - 'docs/zh-CN/**/*.md'
  workflow_dispatch:
    inputs:
      files:
        description: 'Specific files to translate (comma-separated, optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history to detect changes
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Detect changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.files }}" ]; then
            echo "files=${{ github.event.inputs.files }}" >> $GITHUB_OUTPUT
          else
            # Get changed markdown files in zh-CN directory
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'docs/zh-CN/**/*.md' | tr '\n' ',')
            echo "files=${CHANGED_FILES%,}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run translation
        if: steps.changed-files.outputs.files != ''
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          echo "Translating files: $CHANGED_FILES"
          node scripts/translate-docs.js
      
      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/en-US/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: auto-translate documentation from zh-CN to en-US"
          title: "ğŸ¤– Auto-translate docs from zh-CN to en-US"
          body: |
            ## ğŸ“š Documentation Translation
            
            This PR contains automated translations from Chinese to English documentation.
            
            ### ğŸ“ Changed Files
            **Source files**: 
            ```
            ${{ steps.changed-files.outputs.files }}
            ```
            
            ### âœ… Checklist
            - [ ] Translation accuracy reviewed
            - [ ] Technical terms are correct
            - [ ] Markdown formatting preserved
            - [ ] Links and references updated
            
            ### ğŸ¤– Translation Details
            - **Service**: DeepSeek API
            - **Model**: deepseek-chat
            - **Timestamp**: ${{ github.event.head_commit.timestamp }}
            
            ---
            *This PR was automatically generated by the translation workflow.*
          branch: auto-translate/${{ github.run_number }}
          delete-branch: true